!function($){"use strict";const e={init(){this.cache(),this.bootstrapSaved(),this.bind(),this.sortable(),this.persist()},cache(){this.$list=$("#sf-questions"),this.$tplQ=$("#tpl-question"),this.$tplS=$("#tpl-section"),this.$tplB=$("#tpl-break"),this.$tplP=$("#tpl-preq"),this.$btnQ=$(".sf-add-question"),this.$btnS=$(".sf-add-section"),this.$btnB=$(".sf-add-break"),this.$btnP=$(".sf-add-preq"),this.$save=$(".sf-toolbar-save"),this.$json=$("#surveyflow_questions_json"),this.mediaFrame=null},bootstrapSaved(){let e=[];try{const t=this.$json&&this.$json.val?this.$json.val():"";if(t){const s=JSON.parse(t);Array.isArray(s)&&(e=s)}else window.surveyflowSavedQuestions&&Array.isArray(window.surveyflowSavedQuestions)&&(e=window.surveyflowSavedQuestions)}catch(e){}e&&e.length&&this.loadItems(e)},loadItems(e){e.forEach((e=>{"section"===e.type?this.addSection(e):"break"===e.type?this.addBreak():"prequalifier"===e.type?this.addPreq(e):this.addQuestion(e)}))},bind(){const e=this;this.$btnQ.on("click",(()=>e.addQuestion())),this.$btnS.on("click",(()=>e.addSection())),this.$btnB.on("click",(()=>e.addBreak())),this.$btnP.on("click",(()=>e.addPreq())),this.$save.on("click",(()=>{const e=$("#publish");e.length?e.trigger("click"):$("#post").trigger("submit")})),this.$list.on("click",".sf-remove",(function(){$(this).closest(".sf-item").remove(),e.persist()})),this.$list.on("change",".sf-item-question .sf-type",(function(){e.updateQuestionUI($(this).closest(".sf-item")),e.persist()})),this.$list.on("click",".sf-add-option",(function(){const t=$(this).siblings(".sf-options");e.appendOption(t,$(this).closest(".sf-item").hasClass("sf-item-preq")),e.persist()})),this.$list.on("click",".sf-remove-option",(function(){$(this).closest(".sf-option").remove(),e.persist()})),this.$list.on("input change",".sf-title, .sf-description, .sf-required, .sf-opt-label, .sf-opt-other, .sf-opt-disq, .sf-preq-subtype input[type=radio], .sf-type",(function(){e.persist()})),this.$list.on("click",".sf-media-pick",(t=>{t.preventDefault(),e.pickMedia($(t.currentTarget).closest(".sf-item"))})),this.$list.on("click",".sf-media-clear",(t=>{t.preventDefault();const s=$(t.currentTarget).closest(".sf-item");s.find(".sf-media-url").val(""),s.find(".sf-media-clear").hide(),e.persist()})),$(document).on("click",".sf-preview-survey",(function(e){e.preventDefault();const t=$("#post_ID").val();if(!t)return void alert("Please save the survey first before previewing.");window.open(`${window.location.origin}/?surveyflow_preview=${t}`,"_blank")})),$(document).on("click",".sf-toolbar-toggle",(function(e){e.preventDefault(),window.innerWidth<=782&&$(".sf-toolbar").toggleClass("expanded")})),$(document).on("click",".sf-toolbar.expanded .button:not(.sf-toolbar-toggle)",(function(){window.innerWidth<=782&&$(".sf-toolbar").removeClass("expanded")}))},sortable(){$.fn.sortable&&this.$list.sortable({handle:".sf-handle",stop:()=>this.persist()})},tmplHtml(e){return e&&e.length?e.html():""},addQuestion(e){const t=$(this.tmplHtml(this.$tplQ));this.$list.append(t),e&&this.hydrateQuestion(t,e),this.updateQuestionUI(t),this.persist()},addSection(e){const t=$(this.tmplHtml(this.$tplS));this.$list.append(t),e&&this.hydrateSection(t,e),this.persist()},addBreak(){const e=$(this.tmplHtml(this.$tplB));this.$list.append(e),this.persist()},addPreq(e){const t=$(this.tmplHtml(this.$tplP)),s="preq_"+Date.now()+"_"+Math.floor(1e3*Math.random());t.find('input[name="__PREQ_SUBTYPE__"]').attr("name",s),this.$list.append(t),e&&this.hydratePreq(t,e),this.persist()},updateQuestionUI(e){if(!e.hasClass("sf-item-question"))return;const t=e.find(".sf-type").val(),s="radio"===t||"checkbox"===t||"dropdown"===t;e.find(".sf-options-wrap").toggle(s),e.find(".sf-required-row").toggle("media_upload"!==t)},appendOption(e,t){const s=$('<div class="sf-option"><input type="text" class="sf-opt-label" value=""><label class="sf-opt-flag" style="'+(t?"":"display:none;")+'"><input type="checkbox" class="sf-opt-disq"> Disqualify</label><label class="sf-opt-flag" style="'+(t?"display:none;":"")+'"><input type="checkbox" class="sf-opt-other"> Other</label><button type="button" class="sf-remove-option" aria-label="Remove">Ã—</button></div>');e.append(s)},pickMedia(e){if(!window.wp||!wp.media)return;const t={title:"Select Media",multiple:!1,library:{type:["image","video","audio","application/pdf"]}},s=wp.media(t);s.on("select",(()=>{const t=s.state().get("selection").first().toJSON();e.find(".sf-media-url").val(t.url),e.find(".sf-media-clear").show(),this.persist()})),s.open()},collect(){const e=[];return this.$list.children(".sf-item").each((function(){const t=$(this);if(t.hasClass("sf-item-break"))return void e.push({type:"break"});if(t.hasClass("sf-item-section")){const s=(t.find(".sf-title").val()||"").trim(),i=(t.find(".sf-description").val()||"").trim();return void e.push({type:"section",title:s,description:i})}if(t.hasClass("sf-item-preq")){const s=t.find('input[type=radio][name^="preq_"]:checked').val()||"radio",i=(t.find(".sf-title").val()||"").trim(),a=[];return t.find(".sf-options .sf-option").each((function(){const e=($(this).find(".sf-opt-label").val()||"").trim();if(!e.length)return;const t=$(this).find(".sf-opt-disq").is(":checked")?1:0;a.push({label:e,disqualify:t})})),void e.push({type:"prequalifier",subtype:s,title:i,options:a})}const s=t.find(".sf-type").val(),i=(t.find(".sf-title").val()||"").trim(),a=t.find(".sf-required").is(":checked")?1:0,o={type:s,title:i,required:a},n=[];if("radio"===s||"checkbox"===s||"dropdown"===s){t.find(".sf-options .sf-option").each((function(){const e=($(this).find(".sf-opt-label").val()||"").trim();if(!e.length)return;const t=e.toLowerCase(),i="radio"!==s&&"checkbox"!==s?!1:"other"===t;n.push({label:e,other:i?1:0})})),o.options=n}const r=t.find(".sf-media-url").val()||"";r&&(o.media={url:r}),e.push(o)})),e},persist(){this.$json.val(JSON.stringify(this.collect()))},hydrateQuestion(e,t){t.type&&e.find(".sf-type").val(t.type),t.title&&e.find(".sf-title").val(t.title),this.updateQuestionUI(e),Array.isArray(t.options)&&(()=>{const s=e.find(".sf-options");e.find(".sf-options-wrap").show(),t.options.forEach((e=>{this.appendOption(s,!1);const t=s.children(".sf-option").last();t.find(".sf-opt-label").val(e.label||""),t.find(".sf-opt-other").prop("checked",!!e.other)}))})(),t.required&&e.find(".sf-required").prop("checked",!!t.required),t.media&&t.media.url&&(e.find(".sf-media-url").val(t.media.url),e.find(".sf-media-clear").show())},hydrateSection(e,t){t.title&&e.find(".sf-title").val(t.title),t.description&&e.find(".sf-description").val(t.description)},hydratePreq(e,t){const s=e.find('input[name^="preq_"]').attr("name");e.find(`input[name="${s}"][value="${t.subtype||"radio"}"]`).prop("checked",!0),t.title&&e.find(".sf-title").val(t.title),Array.isArray(t.options)&&(()=>{const s=e.find(".sf-options");t.options.forEach((e=>{this.appendOption(s,!0);const t=s.children(".sf-option").last();t.find(".sf-opt-label").val(e.label||""),t.find(".sf-opt-disq").prop("checked",!!e.disqualify)}))})()} };$(function(){e.init()})}(jQuery);
